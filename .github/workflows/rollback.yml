name: Rollback Production

on:
  workflow_dispatch:
    inputs:
      target_version:
        description: 'Git tag to rollback to (e.g. v1.2.3). Leave empty for previous version.'
        required: false
        type: string
      rollback_reason:
        description: 'Reason for rollback (audit trail)'
        required: true
        type: string

env:
  AZURE_WEBAPP_NAME: bnoon
  SITE_URL: https://bnoon.sa

permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Discover available versions
  # ──────────────────────────────────────────────
  discover-versions:
    runs-on: ubuntu-latest
    outputs:
      rollback_tag: ${{ steps.resolve.outputs.ROLLBACK_TAG }}
      rollback_commit: ${{ steps.resolve.outputs.ROLLBACK_COMMIT }}
      current_tag: ${{ steps.resolve.outputs.CURRENT_TAG }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: List recent versions
        run: |
          echo "### Available Versions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Tag | Date | Commit |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|------|--------|" >> $GITHUB_STEP_SUMMARY

          git tag -l 'v*' --sort=-v:refname | head -10 | while read tag; do
            DATE=$(git log -1 --format="%ci" "$tag" 2>/dev/null | cut -d' ' -f1)
            COMMIT=$(git rev-list -n 1 "$tag" 2>/dev/null | cut -c1-8)
            echo "| $tag | $DATE | $COMMIT |" >> $GITHUB_STEP_SUMMARY
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Rollback reason:** ${{ inputs.rollback_reason }}" >> $GITHUB_STEP_SUMMARY

      - name: Resolve rollback target
        id: resolve
        run: |
          # Get current (latest) tag
          CURRENT_TAG=$(git tag -l 'v*' --sort=-v:refname | head -1)
          echo "Current tag: ${CURRENT_TAG:-none}"

          if [ -n "${{ inputs.target_version }}" ]; then
            # User specified a version
            TARGET_TAG="${{ inputs.target_version }}"

            # Validate tag exists
            if ! git rev-parse "$TARGET_TAG" >/dev/null 2>&1; then
              echo "::error::Tag '$TARGET_TAG' does not exist"
              exit 1
            fi
          else
            # Auto-select previous version
            TARGET_TAG=$(git tag -l 'v*' --sort=-v:refname | sed -n '2p')

            if [ -z "$TARGET_TAG" ]; then
              echo "::error::No previous version tag found. Cannot auto-detect rollback target."
              exit 1
            fi
          fi

          TARGET_COMMIT=$(git rev-list -n 1 "$TARGET_TAG")
          echo "Rollback target: $TARGET_TAG ($TARGET_COMMIT)"

          echo "ROLLBACK_TAG=$TARGET_TAG" >> $GITHUB_OUTPUT
          echo "ROLLBACK_COMMIT=$TARGET_COMMIT" >> $GITHUB_OUTPUT
          echo "CURRENT_TAG=${CURRENT_TAG:-unknown}" >> $GITHUB_OUTPUT

  # ──────────────────────────────────────────────
  # Job 2: Execute Rollback (manual approval)
  # ──────────────────────────────────────────────
  execute-rollback:
    runs-on: ubuntu-latest
    needs: discover-versions
    environment: production
    steps:
      - name: Checkout rollback commit
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.discover-versions.outputs.rollback_commit }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: '.node-version'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js app
        run: npm run build
        env:
          NEXT_PUBLIC_RECAPTCHA_SITE_KEY: ${{ secrets.NEXT_PUBLIC_RECAPTCHA_SITE_KEY }}

      - name: Prune dev dependencies
        run: npm prune --omit=dev

      - name: Prepare release package
        run: |
          mkdir -p release
          cp -r .next release/.next
          cp -r public release/public
          cp -r node_modules release/node_modules
          cp package.json release/
          cp server.js release/
          cp next.config.js release/ 2>/dev/null || true
          cp next.config.ts release/ 2>/dev/null || true
          cp next.config.mjs release/ 2>/dev/null || true

      - name: Create deployment ZIP
        run: cd release && zip -r -q ../release.zip .

      - name: Deploy to Azure Web App
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME }}
          publish-profile: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          package: release.zip

      - name: Rollback summary
        run: |
          echo "### Rollback Executed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| **From** | ${{ needs.discover-versions.outputs.current_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **To** | ${{ needs.discover-versions.outputs.rollback_tag }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | ${{ needs.discover-versions.outputs.rollback_commit }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Reason** | ${{ inputs.rollback_reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Triggered by** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY

  # ──────────────────────────────────────────────
  # Job 3: Verify Rollback
  # ──────────────────────────────────────────────
  verify-rollback:
    runs-on: ubuntu-latest
    needs: execute-rollback
    steps:
      - name: Wait for app startup
        run: sleep 30

      - name: Health check
        run: |
          HEALTH_URL="${{ env.SITE_URL }}/api/health"
          MAX_ATTEMPTS=30
          WAIT_SECONDS=10
          SUCCESS_COUNT=0
          REQUIRED_SUCCESSES=3

          echo "Polling $HEALTH_URL (max ${MAX_ATTEMPTS} attempts, ${WAIT_SECONDS}s interval)"

          for i in $(seq 1 $MAX_ATTEMPTS); do
            HTTP_CODE=$(curl -sL -o /tmp/health_response.json -w "%{http_code}" --max-time 15 "$HEALTH_URL" 2>/dev/null || echo "000")

            if [ "$HTTP_CODE" = "200" ]; then
              STATUS=$(cat /tmp/health_response.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('status',''))" 2>/dev/null || echo "")
              VERSION=$(cat /tmp/health_response.json | python3 -c "import sys,json; print(json.load(sys.stdin).get('version',''))" 2>/dev/null || echo "")

              if [ "$STATUS" = "healthy" ]; then
                SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
                echo "Attempt $i: healthy (v${VERSION}) [$SUCCESS_COUNT/$REQUIRED_SUCCESSES]"

                if [ "$SUCCESS_COUNT" -ge "$REQUIRED_SUCCESSES" ]; then
                  echo ""
                  echo "Rollback verified successfully!"
                  echo "### Rollback Verified" >> $GITHUB_STEP_SUMMARY
                  echo "- **Health**: healthy" >> $GITHUB_STEP_SUMMARY
                  echo "- **Version**: ${VERSION}" >> $GITHUB_STEP_SUMMARY
                  exit 0
                fi
              else
                SUCCESS_COUNT=0
                echo "Attempt $i: HTTP 200 but status='${STATUS}'"
              fi
            else
              SUCCESS_COUNT=0
              echo "Attempt $i: HTTP $HTTP_CODE (waiting...)"
            fi

            sleep $WAIT_SECONDS
          done

          echo "Health check failed after $MAX_ATTEMPTS attempts"
          echo "### Rollback Verification FAILED" >> $GITHUB_STEP_SUMMARY
          exit 1
